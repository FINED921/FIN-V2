local WindUI = loadstring(game:HttpGet("https://github.com/Footagesus/WindUI/releases/latest/download/main.lua"))()

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local TextChatService = game:GetService("TextChatService")

local StaminaSettings = {
    StaminaLoss = 10,
    StaminaGain = 25,
    InfiniteGain = 9999
}

WindUI:Popup({
    Title = "æ¬¢è¿ä½¿ç”¨FINè„šæœ¬",
    Icon = "sparkles",
    Content = "å°Šæ•¬çš„FINç”¨æˆ·ğŸ‘‘,ç¥ä½ å¤©å¤©å¼€å¿ƒ",
    Buttons = {
        {
            Title = "å¯åŠ¨",
            Icon = "arrow-right",
            Variant = "Primary",
            Callback = function() 
                print("å¯åŠ¨è¢«é—å¼ƒ")
                -- åˆ›å»ºä¸»çª—å£
                createMainWindow()
            end
        }
    }
})

function createMainWindow()
    local Players = game:GetService("Players")
    local LocalPlayer = Players.LocalPlayer
    local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local hum = Character:WaitForChild("HumanoidRootPart")
    local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")
    
    -- å£°æ˜æ‰€æœ‰çº¿ç¨‹æ§åˆ¶å˜é‡
    local teleportMedkitThread, teleportColaThread, medkitThread, colaThread
    local autoTeleportMedkitEnabled, autoTeleportColaEnabled, autoMedkitEnabled, autoColaEnabled

    local Window = WindUI:CreateWindow({
        Title = "FIN | è¢«é—å¼ƒ",
        Icon = "rbxassetid://129260712070622",
        IconThemed = true,
        Author = "ä½œè€…:é‘«æ™´",
        Folder = "CloudHub",
        Size = UDim2.fromOffset(300, 270),
        Transparent = true,
        Theme = "Dark",
        User = {
            Enabled = true,
            Callback = function() print("clicked") end,
            Anonymous = false
        },
        SideBarWidth = 200,
        ScrollBarEnabled = true,
    })

    Window:Tag({
        Title = "v1.3.4",
        Color = Color3.fromHex("#30ff6a")
    })
    Window:Tag({
        Title = "æµ‹è¯•ç‰ˆ", 
        Color = Color3.fromHex("#315dff")
    })
    local TimeTag = Window:Tag({
        Title = "æŒç»­æ›´æ–°",
        Color = Color3.fromHex("#000000")
    })

    Window:EditOpenButton({
        Title = "FIN | è¢«é—å¼ƒ",
        Icon = "star",
        CornerRadius = UDim.new(0,16),
        StrokeThickness = 2,
        Color = ColorSequence.new(
            Color3.fromHex("FF0F7B"), 
            Color3.fromHex("F89B29")
        ),
        Draggable = true,
    })

    local Tab = Window:Tab({
        Title = "åŸºç¡€åŠŸèƒ½",
        Icon = "drama",
        Locked = false,
    })

    local Toggle = Tab:Toggle({
        Title = "æ˜¾ç¤ºå±€å†…èŠå¤©æ¡†",
        Desc = "FIN",
        Locked = false,
        Callback = function(state)
            if TextChatService:FindFirstChild("ChatWindowConfiguration") then
                TextChatService.ChatWindowConfiguration.Enabled = state
            end
        end
    })

    local Tab2 = Window:Tab({
        Title = "ä½“åŠ›æ¶ˆè€—",
        Icon = "drama",
        Locked = false,
    })

    local function GetSprintingModule()
        if ReplicatedStorage:FindFirstChild("Systems") and
           ReplicatedStorage.Systems:FindFirstChild("Character") and
           ReplicatedStorage.Systems.Character:FindFirstChild("Game") and
           ReplicatedStorage.Systems.Character.Game:FindFirstChild("Sprinting") then
            return require(ReplicatedStorage.Systems.Character.Game.Sprinting)
        end
        return nil
    end

    local bai = {Spr = false}
    local connection

    local Toggle2 = Tab2:Toggle({
        Title = "æ— é™ä½“åŠ›",
        Desc = "FIN",
        Locked = false,
        Callback = function(state)
            bai.Spr = state
            local Sprinting = GetSprintingModule()
            
            if not Sprinting then
                warn("æ— æ³•æ‰¾åˆ°ä½“åŠ›æ¨¡å—!")
                return
            end

            if state then
                Sprinting.StaminaLoss = 0
                Sprinting.StaminaGain = StaminaSettings.InfiniteGain or 9999

                if connection then connection:Disconnect() end
                connection = RunService.Heartbeat:Connect(function()
                    if not bai.Spr then 
                        connection:Disconnect()
                        return 
                    end
                    Sprinting.StaminaLoss = 0
                    Sprinting.StaminaGain = StaminaSettings.InfiniteGain or 9999
                end)
            else
                Sprinting.StaminaLoss = StaminaSettings.StaminaLoss or 10
                Sprinting.StaminaGain = StaminaSettings.StaminaGain or 25

                if connection then
                    connection:Disconnect()
                    connection = nil
                end
            end
        end
    })

    local Tab3 = Window:Tab({
        Title = "è‡ªåŠ¨æ”¶å–ç‰©å“",
        Icon = "drama",
        Locked = false,
    })

    local Toggle3 = Tab3:Toggle({
        Title = "åŒ»ç–—åŒ…ä¼ é€ä¸”è·å–",
        Desc = "FIN",
        Locked = false,
        Callback = function(state)
            autoTeleportMedkitEnabled = state
            
            if autoTeleportMedkitEnabled then
                teleportMedkitThread = task.spawn(function()
                    while autoTeleportMedkitEnabled and task.wait(0.5) do
                        local character = game.Players.LocalPlayer.Character
                        if character and character:FindFirstChild("HumanoidRootPart") then
                            local humanoidRootPart = character.HumanoidRootPart
                            
                            local medkit = workspace:FindFirstChild("Map", true)
                            if medkit then
                                medkit = medkit:FindFirstChild("Ingame", true)
                                if medkit then
                                    medkit = medkit:FindFirstChild("Medkit", true)
                                    if medkit then
                                        local itemRoot = medkit:FindFirstChild("ItemRoot", true)
                                        if itemRoot then
                                            itemRoot.CFrame = humanoidRootPart.CFrame + humanoidRootPart.CFrame.LookVector * 3
                                            
                                            local prompt = itemRoot:FindFirstChild("ProximityPrompt", true)
                                            if prompt then
                                                fireproximityprompt(prompt)
                                            end
                                        end
                                    end
                                end
                            end
                        end
                    end
                end)
            elseif teleportMedkitThread then
                task.cancel(teleportMedkitThread)
                teleportMedkitThread = nil
            end
        end
    })

    local Toggle4 = Tab3:Toggle({
        Title = "å¯ä¹ç½ä¼ é€ä¸”è·å–",
        Desc = "FIN",
        Locked = false,
        Callback = function(state)
            autoTeleportColaEnabled = state
            
            if autoTeleportColaEnabled then
                teleportColaThread = task.spawn(function()
                    while autoTeleportColaEnabled and task.wait(0.5) do
                        local character = game.Players.LocalPlayer.Character
                        if character and character:FindFirstChild("HumanoidRootPart") then
                            local humanoidRootPart = character.HumanoidRootPart
                            
                            local cola = workspace:FindFirstChild("Map", true)
                            if cola then
                                cola = cola:FindFirstChild("Ingame", true)
                                if cola then
                                    cola = cola:FindFirstChild("BloxyCola", true)
                                    if cola then
                                        local itemRoot = cola:FindFirstChild("ItemRoot", true)
                                        if itemRoot then
                                            itemRoot.CFrame = humanoidRootPart.CFrame + humanoidRootPart.CFrame.LookVector * 3
                                            
                                            local prompt = itemRoot:FindFirstChild("ProximityPrompt", true)
                                            if prompt then
                                                fireproximityprompt(prompt)
                                            end
                                        end
                                    end
                                end
                            end
                        end
                    end
                end)
            elseif teleportColaThread then
                task.cancel(teleportColaThread)
                teleportColaThread = nil
            end
        end
    })

    local Toggle5 = Tab3:Toggle({
        Title = "è‡ªåŠ¨äº’åŠ¨åŒ»ç–—åŒ…",
        Desc = "ä¸å…³ä¸Šæ— æ³•ä¸¢å¼ƒğŸ’€",
        Locked = false,
        Callback = function(state)
            autoMedkitEnabled = state
            
            if autoMedkitEnabled then
                medkitThread = task.spawn(function()
                    while autoMedkitEnabled and task.wait(0.5) do
                        local medkit = workspace:FindFirstChild("Map", true)
                        if medkit then
                            medkit = medkit:FindFirstChild("Ingame", true)
                            if medkit then
                                medkit = medkit:FindFirstChild("Medkit", true)
                                if medkit then
                                    local itemRoot = medkit:FindFirstChild("ItemRoot", true)
                                    if itemRoot then
                                        local prompt = itemRoot:FindFirstChild("ProximityPrompt", true)
                                        if prompt then
                                            fireproximityprompt(prompt)
                                        end
                                    end
                                end
                            end
                        end
                    end
                end)
            elseif medkitThread then
                task.cancel(medkitThread)
                medkitThread = nil
            end
        end
    })

    local Toggle6 = Tab3:Toggle({
        Title = "è‡ªåŠ¨äº’åŠ¨å¯ä¹ç½",
        Desc = "ä¸å…³ä¸Šæ— æ³•ä¸¢å¼ƒğŸ’€",
        Locked = false,
        Callback = function(state)
            autoColaEnabled = state
            
            if autoColaEnabled then
                colaThread = task.spawn(function()
                    while autoColaEnabled and task.wait(0.5) do
                        local cola = workspace:FindFirstChild("Map", true)
                        if cola then
                            cola = cola:FindFirstChild("Ingame", true)
                            if cola then
                                cola = cola:FindFirstChild("BloxyCola", true)
                                if cola then
                                    local itemRoot = cola:FindFirstChild("ItemRoot", true)
                                    if itemRoot then
                                        local prompt = itemRoot:FindFirstChild("ProximityPrompt", true)
                                        if prompt then
                                            fireproximityprompt(prompt)
                                        end
                                    end
                                end
                            end
                        end
                    end
                end)
            elseif colaThread then
                task.cancel(colaThread)
                colaThread = nil
            end
        end
    })

    local Tab4 = Window:Tab({
        Title = "ä¿®å‘åŠ¨æœº",
        Icon = "drama",
        Locked = false,
    })

    local Toggle7 = Tab4:Toggle({
        Title = "è‡ªåŠ¨ä¿®æœº",
        Desc = "FIN",
        Locked = false,
        Callback = function(state)
            _G.BTE = state
            _G.REP = _G.REP or 1.80

            local function RepairGenerators()
                local map = workspace:FindFirstChild("Map")
                local ingame = map and map:FindFirstChild("Ingame")
                local currentMap = ingame and ingame:FindFirstChild("Map")

                if currentMap then
                    for _, obj in ipairs(currentMap:GetChildren()) do
                        if obj.Name == "Generator" and obj:FindFirstChild("Progress") and obj.Progress.Value < 100 then
                            local remote = obj:FindFirstChild("Remotes") and obj.Remotes:FindFirstChild("RE")
                            if remote then
                                remote:FireServer()
                            end
                        end
                    end
                end
            end

            if state then
                task.spawn(function()
                    while _G.BTE do
                        RepairGenerators()
                        task.wait(_G.REP)
                    end
                end)
            end
        end
    })

    local Tab5 = Window:Tab({
        Title = "ç»˜åˆ¶",
        Icon = "drama",
        Locked = false,
    })

    -- åˆå§‹åŒ–è®¾ç½®
    local DistanceSettings = {
        ShowSurvivors = true,
        ShowKillers = true,
        SurvivorColor = Color3.fromRGB(0, 191, 255), -- é»˜è®¤å¹¸å­˜è€…è“è‰²
        KillerColor = Color3.fromRGB(255, 0, 0),     -- é»˜è®¤æ€æ‰‹çº¢è‰²
        TextSize = 14
    }

    -- è·ç¦»æ˜¾ç¤ºåŠŸèƒ½
    local function updateDistanceDisplay()
        -- å…ˆå…³é—­ç°æœ‰è¿æ¥
        if getgenv().distanceUnderFeetConnection then
            getgenv().distanceUnderFeetConnection:Disconnect()
        end
        
        if getgenv().characterRemovedConnection then
            getgenv().characterRemovedConnection:Disconnect()
        end
        
        -- å¦‚æœä¸¤ä¸ªéƒ½å…³é—­åˆ™å®Œå…¨ç¦ç”¨
        if not DistanceSettings.ShowSurvivors and not DistanceSettings.ShowKillers then
            if getgenv().distanceUnderFeetLabels then
                for _, data in pairs(getgenv().distanceUnderFeetLabels) do
                    pcall(function() data.label:Remove() end)
                end
                getgenv().distanceUnderFeetLabels = nil
            end
            return
        end
        
        -- åˆå§‹åŒ–å˜é‡
        local players = game:GetService("Players")
        local runService = game:GetService("RunService")
        local localPlayer = players.LocalPlayer
        local camera = workspace.CurrentCamera
        
        -- å­˜å‚¨æ‰€æœ‰è·ç¦»æ ‡ç­¾
        getgenv().distanceUnderFeetLabels = getgenv().distanceUnderFeetLabels or {}
        
        -- ä¸»å¾ªç¯
        getgenv().distanceUnderFeetConnection = runService.RenderStepped:Connect(function()
            local localChar = localPlayer.Character
            if not localChar or not localChar:FindFirstChild("HumanoidRootPart") then return end
            
            local localPos = localChar.HumanoidRootPart.Position
            
            -- å¤„ç†å¹¸å­˜è€…
            if DistanceSettings.ShowSurvivors then
                local survivors = workspace.Players:FindFirstChild("Survivors")
                if survivors then
                    for _, survivor in ipairs(survivors:GetChildren()) do
                        if survivor:IsA("Model") and survivor ~= localChar then
                            local hrp = survivor:FindFirstChild("HumanoidRootPart")
                            if hrp then
                                if not getgenv().distanceUnderFeetLabels[survivor] then
                                    getgenv().distanceUnderFeetLabels[survivor] = {
                                        label = Drawing.new("Text"),
                                        type = "Survivor"
                                    }
                                    local label = getgenv().distanceUnderFeetLabels[survivor].label
                                    label.Size = DistanceSettings.TextSize
                                    label.Center = true
                                    label.Outline = true
                                    label.Font = 2
                                end
                                
                                local data = getgenv().distanceUnderFeetLabels[survivor]
                                local distance = math.floor((hrp.Position - localPos).Magnitude)
                                local screenPos, onScreen = camera:WorldToViewportPoint(hrp.Position - Vector3.new(0, 3, 0))
                                
                                if onScreen then
                                    data.label.Position = Vector2.new(screenPos.X, screenPos.Y)
                                    data.label.Text = tostring(distance) .. "m"
                                    data.label.Color = DistanceSettings.SurvivorColor
                                    data.label.Visible = true
                                else
                                    data.label.Visible = false
                                end
                            end
                        end
                    end
                end
            else
                -- éšè—æ‰€æœ‰å¹¸å­˜è€…æ ‡ç­¾
                for model, data in pairs(getgenv().distanceUnderFeetLabels or {}) do
                    if data.type == "Survivor" then
                        data.label.Visible = false
                    end
                end
            end
            
            -- å¤„ç†æ€æ‰‹
            if DistanceSettings.ShowKillers then
                local killers = workspace.Players:FindFirstChild("Killers")
                if killers then
                    for _, killer in ipairs(killers:GetChildren()) do
                        if killer:IsA("Model") then
                            local hrp = killer:FindFirstChild("HumanoidRootPart")
                            if hrp then
                                if not getgenv().distanceUnderFeetLabels[killer] then
                                    getgenv().distanceUnderFeetLabels[killer] = {
                                        label = Drawing.new("Text"),
                                        type = "Killer"
                                    }
                                    local label = getgenv().distanceUnderFeetLabels[killer].label
                                    label.Size = DistanceSettings.TextSize
                                    label.Center = true
                                    label.Outline = true
                                    label.Font = 2
                                end
                                
                                local data = getgenv().distanceUnderFeetLabels[killer]
                                local distance = math.floor((hrp.Position - localPos).Magnitude)
                                local screenPos, onScreen = camera:WorldToViewportPoint(hrp.Position - Vector3.new(0, 3, 0))
                                
                                if onScreen then
                                    data.label.Position = Vector2.new(screenPos.X, screenPos.Y)
                                    data.label.Text = tostring(distance) .. "m"
                                    data.label.Color = DistanceSettings.KillerColor
                                    data.label.Visible = true
                                else
                                    data.label.Visible = false
                                end
                            end
                        end
                    end
                end
            else
                -- éšè—æ‰€æœ‰æ€æ‰‹æ ‡ç­¾
                for model, data in pairs(getgenv().distanceUnderFeetLabels or {}) do
                    if data.type == "Killer" then
                        data.label.Visible = false
                    end
                end
            end
        end)
        
        -- ç›‘å¬è§’è‰²ç§»é™¤
        getgenv().characterRemovedConnection = workspace.Players.DescendantRemoving:Connect(function(descendant)
            if descendant:IsA("Model") and getgenv().distanceUnderFeetLabels and getgenv().distanceUnderFeetLabels[descendant] then
                getgenv().distanceUnderFeetLabels[descendant].label:Remove()
                getgenv().distanceUnderFeetLabels[descendant] = nil
            end
        end)
    end

    local Toggle8 = Tab5:Toggle({
        Title = "ç»˜åˆ¶å¹¸å­˜è€…è·ç¦»",
        Desc = "FIN",
        Locked = false,
        Callback = function(enabled)
            DistanceSettings.ShowSurvivors = enabled
            if getgenv().distanceUnderFeetConnection then
                updateDistanceDisplay()
            end
        end
    })

    local Toggle9 = Tab5:Toggle({
        Title = "ç»˜åˆ¶æ€æ‰‹è·ç¦»",
        Desc = "FIN",
        Locked = false,
        Callback = function(enabled)
            DistanceSettings.ShowKillers = enabled
            if getgenv().distanceUnderFeetConnection then
                updateDistanceDisplay()
            end
        end
    })
end

-- æ¸…ç†é«˜äº®å¯¹è±¡
local function cleanupHighlights()
    for _, highlight in pairs(HighlightSettings.highlights) do
        if highlight and highlight.Parent then
            highlight:Destroy()
        end
    end
    HighlightSettings.highlights = {}
end

-- æ›´æ–°é«˜äº®æ˜¾ç¤º
local function updateHighlights()
    local players = game:GetService("Players")
    local localPlayer = players.LocalPlayer
    
    -- è·å–å¹¸å­˜è€…å’Œæ€æ‰‹æ–‡ä»¶å¤¹
    local survivorsFolder = workspace:FindFirstChild("Players") and workspace.Players:FindFirstChild("Survivors")
    local killersFolder = workspace:FindFirstChild("Players") and workspace.Players:FindFirstChild("Killers")
    
    -- åªå¤„ç†å¹¸å­˜è€…å’Œæ€æ‰‹
    local function processFolder(folder, isKiller)
        if not folder then return end
        
        for _, model in ipairs(folder:GetChildren()) do
            if model:IsA("Model") then
                -- ç¡®å®šé¢œè‰²
                local fillColor = isKiller and HighlightSettings.KillerColors[HighlightSettings.SelectedKillerColor] 
                                          or HighlightSettings.SurvivorColors[HighlightSettings.SelectedSurvivorColor]
                
                local outlineColor = isKiller and HighlightSettings.KillerOutlineColors[HighlightSettings.SelectedKillerOutlineColor] 
                                              or HighlightSettings.SurvivorOutlineColors[HighlightSettings.SelectedSurvivorOutlineColor]
                
                -- æ ¹æ®è®¾ç½®å†³å®šæ˜¯å¦æ˜¾ç¤º
                if (isKiller and HighlightSettings.ShowKillerHighlights) or 
                   (not isKiller and HighlightSettings.ShowSurvivorHighlights) then
                    
                    if not HighlightSettings.highlights[model] then
                        local highlight = Instance.new("Highlight")
                        highlight.Parent = game.CoreGui
                        HighlightSettings.highlights[model] = highlight
                    end
                    
                    local highlight = HighlightSettings.highlights[model]
                    highlight.Adornee = model
                    highlight.FillColor = fillColor
                    highlight.OutlineColor = outlineColor
                    highlight.FillTransparency = HighlightSettings.FillTransparency
                    highlight.OutlineTransparency = HighlightSettings.OutlineTransparency
                elseif HighlightSettings.highlights[model] then
                    HighlightSettings.highlights[model].Adornee = nil
                end
            end
        end
    end
    
    -- å¤„ç†å¹¸å­˜è€…
    processFolder(survivorsFolder, false)
    
    -- å¤„ç†æ€æ‰‹
    processFolder(killersFolder, true)
    
    -- æ¸…ç†ä¸å†å­˜åœ¨çš„æ¨¡å‹çš„é«˜äº®
    for model, highlight in pairs(HighlightSettings.highlights) do
        if not model or not model.Parent then
            highlight:Destroy()
            HighlightSettings.highlights[model] = nil
        end
    end
end

local Toggle10 = Tab5:Toggle({
        Title = "å¯åŠ¨ç»˜åˆ¶",
        Desc = "FIN",
        Locked = false,
        Callback = function(enabled)
        if enabled then
            -- åˆå§‹åŒ–è¿æ¥
            if not HighlightSettings.connection then
                HighlightSettings.connection = game:GetService("RunService").RenderStepped:Connect(updateHighlights)
            end
        else
            -- å…³é—­è¿æ¥
            if HighlightSettings.connection then
                HighlightSettings.connection:Disconnect()
                HighlightSettings.connection = nil
            end
            -- æ¸…ç†é«˜äº®å¯¹è±¡
            cleanupHighlights()
        end
    end
})

local Toggle11 = Tab5:Toggle({
        Title = "ç»˜åˆ¶å¹¸å­˜è€…",
        Desc = "FIN",
        Locked = false,
        Callback = function(enabled)
        HighlightSettings.ShowSurvivorHighlights = enabled
    end
})

local Toggle12 = Tab5:Toggle({
        Title = "ç»˜åˆ¶å¹¸å­˜è€…",
        Desc = "FIN",
        Locked = false,
        Callback = function(enabled)
        HighlightSettings.ShowKillerHighlights = enabled
    end
})
